var plik=angular.module("plik",["ngRoute","api","config","dialog","paste","contentEditable","btford.markdown"]).config(["$routeProvider",function(e){e.when("/",{controller:"MainCtrl",templateUrl:"partials/main.html",reloadOnSearch:!1}).when("/clients",{controller:"ClientListCtrl",templateUrl:"partials/clients.html"}).when("/login",{controller:"LoginCtrl",templateUrl:"partials/login.html"}).when("/home",{controller:"HomeCtrl",templateUrl:"partials/home.html"}).when("/admin",{controller:"AdminCtrl",templateUrl:"partials/admin.html"}).otherwise({redirectTo:"/"})}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).config(["$httpProvider",function(e){e.defaults.headers.common["X-ClientApp"]="web_client",e.defaults.xsrfCookieName="plik-xsrf",e.defaults.xsrfHeaderName="X-XSRFToken",e.interceptors.push(["$q",function(t){return{responseError:function(e){return e.status<=0&&(e.data={status:e.status,message:"Connection failed"}),t.reject(e)}}}])}]).filter("collapseClass",function(){return function(e){return e?"fa fa-caret-down":"fa fa-caret-right"}});function getHumanReadableTTL(e){var t,n,r;return r=-1===e?(t=-1,n="unlimited",3):e<3600?(t=Math.round(e/60),n="minutes",2):e<86400?(t=Math.round(e/3600),n="hours",1):86400<=e?(t=Math.round(e/86400),n="days",0):(n="invalid",t=0),[t,n,r]}function getHumanReadableTTLString(e){var t=getHumanReadableTTL(e);return 0<t[0]?t[0]+" "+t[1]:t[1]}function getTTL(e,t){return e=Number(e),"minutes"===t?60*e:"hours"===t?3600*e:"days"===t?86400*e:-1}function getHumanReadableSize(e){if(!_.isUndefined(e))return-1===e?"unlimited":filesize(e,{base:10})}new ClipboardJS("[data-clipboard]"),angular.module("api",["ngFileUpload"]).factory("$api",["$http","$q","Upload",function(l,s,u){var c={base:window.location.origin+window.location.pathname.replace(/\/$/,""),call:function(e,t,n,r,a){var i=s.defer(),o={};return a&&(o["X-UploadToken"]=a),c.fake_user&&(o["X-Plik-Impersonate"]=c.fake_user.id),l({url:e,method:t,params:n,data:r,headers:o}).then(function(e){i.resolve(e.data)},function(e){var t=e.data?e.data:"Unknown error";i.reject({status:e.status,message:t})}),i.promise},upload:function(e,t,n,r,a){var i=s.defer(),o={};return a&&(o["X-UploadToken"]=a),r&&(o.Authorization="Basic "+r),u.upload({url:e,method:"POST",file:u.rename(t,t.fileName),headers:o}).then(function(e){i.resolve(e.data)},function(e){var t=e.data?e.data:"Unknown error";i.reject({status:e.status,message:t})},n),i.promise},getUpload:function(e,t){var n=c.base+"/upload/"+e;return c.call(n,"GET",{},{},t)},createUpload:function(e){var t=c.base+"/upload";return c.call(t,"POST",{},e)},removeUpload:function(e){var t=c.base+"/upload/"+e.id;return c.call(t,"DELETE",{},{},e.uploadToken)},uploadFile:function(e,t,n,r){var a,i=e.stream?"stream":"file";return a=t.id?c.base+"/"+i+"/"+e.id+"/"+t.id+"/"+t.fileName:c.base+"/"+i+"/"+e.id,c.upload(a,t,n,r,e.uploadToken)},removeFile:function(e,t){var n=e.stream?"stream":"file",r=c.base+"/"+n+"/"+e.id+"/"+t.id+"/"+t.fileName;return c.call(r,"DELETE",{},{},e.uploadToken)},login:function(e,t,n){var r=c.base+"/auth/"+e+"/login";return"local"===e?c.call(r,"POST",{},{login:t,password:n}):c.call(r,"GET")},logout:function(){var e=c.base+"/auth/logout";return c.call(e,"GET")},getUser:function(){var e=c.base+"/me";return c.call(e,"GET")},createUser:function(e){var t=c.base+"/user";return c.call(t,"POST",{},e)},updateUser:function(e){var t=c.base+"/user/"+e.id;return c.call(t,"POST",{},e)},deleteUser:function(e){var t=c.base+"/user/"+e.id;return c.call(t,"DELETE")},getUserTokens:function(e,t){var n=c.base+"/me/token";return c.call(n,"GET",{limit:e,after:t})},getUserUploads:function(e,t,n){var r=c.base+"/me/uploads";return c.call(r,"GET",{token:e,limit:t,after:n})},getUserStats:function(){var e=c.base+"/me/stats";return c.call(e,"GET")},deleteUploads:function(e){var t=c.base+"/me/uploads";return c.call(t,"DELETE",{token:e})},deleteAccount:function(){var e=c.base+"/me";return c.call(e,"DELETE")},createToken:function(e){var t=c.base+"/me/token";return c.call(t,"POST",{},{comment:e})},revokeToken:function(e){var t=c.base+"/me/token/"+e;return c.call(t,"DELETE")},getVersion:function(){var e=c.base+"/version";return c.call(e,"GET")},getConfig:function(){var e=c.base+"/config";return c.call(e,"GET")},getServerStats:function(){var e=c.base+"/stats";return c.call(e,"GET")},getUsers:function(e,t){var n=c.base+"/users";return c.call(n,"GET",{limit:e,after:t})},getUploads:function(e,t,n,r,a,i){var o=c.base+"/uploads";return c.call(o,"GET",{limit:e,after:t,user:n,token:r,sort:a,order:i})}};return c}]),angular.module("config",["api"]).factory("$config",["$rootScope","$api",function(e,t){var n={config:t.getConfig(),user:t.getUser(),getConfig:function(){return n.config?n.config:n.refreshConfig()},refreshConfig:function(){return n.config=t.getConfig(),e.$broadcast("config_refreshed",n.config),n.config},getUser:function(){return n.user?n.user:n.refreshUser()},getOriginalUser:function(){return n.original_user||n.refreshUser(),n.original_user},refreshUser:function(){return n.user=t.getUser(),n.original_user||(n.original_user=n.user),e.$broadcast("user_refreshed",n.user),n.user},getVersion:function(){return n.version?n.version:n.refreshVersion()},refreshVersion:function(){return n.version=t.getVersion(),e.$broadcast("version_refreshed",n.version),n.version},getServerStats:function(){return n.serverStats?n.serverStats:n.refreshServerStats()},refreshServerStats:function(){return n.serverStats=t.getServerStats(),e.$broadcast("serverStats_refreshed",n.serverStats),n.serverStats}};return n}]),angular.module("contentEditable",[]).directive("contenteditable",[function(){return{restrict:"A",require:"?ngModel",scope:{invalidClass:"@",validator:"&"},link:function(t,n,e,r){function a(){var e=n.text();i(e),r.$setViewValue(e)}function i(e){t.validator&&(t.validator(e)?n.removeClass(t.invalidClass):n.addClass(t.invalidClass))}r&&(t.validator=t.validator(),r.$render=function(){var e=r.$viewValue;i(e),n.text(e)},n.on("blur keyup change",function(){t.$evalAsync(a)}))}}}]),angular.module("dialog",["ui.bootstrap"]).factory("$dialog",["$uibModal",function(t){var n={};return"<h1>{{title}}</h1>\n","</div>\n",'<div class="modal-body">\n',"<p>{{message}}</p>\n",'<p ng-show="data.value">\n',"{{value}}\n","</p>\n","</div>\n",'<div class="modal-footer" ng-if="confirm">\n','<button ng-click="$dismiss()" class="btn btn-danger">Cancel</button>\n','<button ng-click="$close()" class="btn btn-success">OK</button>\n',"</div>\n",'<div class="modal-footer" ng-if="!confirm">\n','<button ng-click="$close()" class="btn btn-primary">Close</button>\n',"</div>\n",n.alert=function(e){var t={backdrop:!0,backdropClick:!0,template:'<div class="modal-header">\n<h1>{{title}}</h1>\n</div>\n<div class="modal-body">\n<p>{{message}}</p>\n<p ng-show="data.value">\n{{value}}\n</p>\n</div>\n<div class="modal-footer" ng-if="confirm">\n<button ng-click="$dismiss()" class="btn btn-danger">Cancel</button>\n<button ng-click="$close()" class="btn btn-success">OK</button>\n</div>\n<div class="modal-footer" ng-if="!confirm">\n<button ng-click="$close()" class="btn btn-primary">Close</button>\n</div>\n',controller:"AlertDialogController",resolve:{args:function(){return _.isObject(e)||(e={message:e}),{data:angular.copy(e)}}}};return n.openDialog(t)},n.openDialog=function(e){return t.open(e)},n}]),plik.controller("AlertDialogController",["$scope","args",function(e,t){_.extend(e,t.data),e.title||e.status&&(100===e.status?e.title="Success !":e.title="Oops ! ("+e.status+")")}]),plik.controller("PasswordController",["$scope",function(n){setTimeout(function(){$("#login").focus()},100),n.title="Please fill credentials !",n.login="user",n.password="",n.close=function(e,t){0<e.length&&0<t.length&&n.$close({login:e,password:t})}}]),plik.controller("PasteController",["$scope","args",function(t,e){setTimeout(function(){$("#text").focus();var e=70*document.documentElement.clientHeight/100+"px";$("#text").css("height",e)},100),t.title="Enter text :",t.text=e.text,t.close=function(e){e.length&&t.$close({text:e})}}]),plik.controller("QRCodeController",["$scope","args",function(e,t){e.args=t}]),angular.module("paste",[]).factory("$paste",function(){var n={callback:null,register:function(e){n.callback=e},unregister:function(){n.callback=null}};return window.addEventListener("paste",function(e){if(n.callback){var t=e.clipboardData||window.clipboardData;n.callback(t)}}),n}),ttlUnits=["days","hours","minutes","unlimited"];var validAmount=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},parsableUnit=function(e){return e.match(/\D*/).pop()===e},incrementBases={2:[[["b","bit","bits"],1/8],[["B","Byte","Bytes","bytes"],1],[["Kb"],128],[["k","K","kb","KB","KiB","Ki","ki"],1024],[["Mb"],131072],[["m","M","mb","MB","MiB","Mi","mi"],Math.pow(1024,2)],[["Gb"],1342e5],[["g","G","gb","GB","GiB","Gi","gi"],Math.pow(1024,3)],[["Tb"],1374e8],[["t","T","tb","TB","TiB","Ti","ti"],Math.pow(1024,4)],[["Pb"],1407e11],[["p","P","pb","PB","PiB","Pi","pi"],Math.pow(1024,5)],[["Eb"],1441e14],[["e","E","eb","EB","EiB","Ei","ei"],Math.pow(1024,6)]],10:[[["b","bit","bits"],1/8],[["B","Byte","Bytes","bytes"],1],[["Kb"],125],[["k","K","kb","KB","KiB","Ki","ki"],1e3],[["Mb"],125e3],[["m","M","mb","MB","MiB","Mi","mi"],1e6],[["Gb"],125e6],[["g","G","gb","GB","GiB","Gi","gi"],1e9],[["Tb"],125e9],[["t","T","tb","TB","TiB","Ti","ti"],1e12],[["Pb"],125e12],[["p","P","pb","PB","PiB","Pi","pi"],1e15],[["Eb"],125e15],[["e","E","eb","EB","EiB","Ei","ei"],1e18]]};function parseHumanReadableSize(e){if(!_.isUndefined(e)){var t=arguments[1]||{},n=parseInt(t.base||2),r=e.toString().match(/^([0-9\.,]*)(?:\s*)?(.*)$/),a=r[1].replace(",","."),i=r[2],o=function(e){return e===i};if(validAmount(a)&&parsableUnit(i)){if(""===i)return Math.round(Number(a));for(var l=incrementBases[n],s=0;s<l.length;s++){var u=l[s];if(u[0].some(o))return Math.round(a*u[1])}}}}plik.controller("AdminCtrl",["$scope","$api","$config","$dialog","$location",function(r,a,t,i,n){r.config={},r.sort_uploads={selected:"date"},r.sort_uploads_order={selected:"desc"},t.config.then(function(e){e.authentication||n.path("/"),r.config=e,t.getOriginalUser().then(function(e){(r.original_user=e).admin||n.path("/"),t.getVersion().then(function(e){r.version=e}).then(null,function(e){i.alert(e)})}).then(null,function(e){i.alert(e)})}).then(null,function(e){i.alert(e)}),r.displayStats=function(){r.stats=void 0,r.users=void 0,r.display="stats",t.getServerStats().then(function(e){r.stats=e}).then(null,function(e){i.alert(e)})},r.displayUsers=function(e){e||(r.stats=void 0,r.users=[],r.uploads=[],r.cursor=void 0,r.display="users",r.fake_user=a.fake_user),r.limit=50,a.getUsers(r.limit,r.cursor).then(function(e){r.users=r.users.concat(e.results),r.cursor=e.after}).then(null,function(e){i.alert(e)})},r.displayUploads=function(e,t,n){e||(r.stats=void 0,r.users=[],r.uploads=[],r.cursor=void 0,r.display="uploads",r.user=void 0,r.token=void 0),t&&(r.user=t,n&&(r.token=n)),r.limit=50,console.log(r.sort_uploads),a.getUploads(r.limit,r.cursor,r.user,r.token,r.sort_uploads.selected,r.sort_uploads_order.selected).then(function(e){r.uploads=r.uploads.concat(e.results),r.cursor=e.after}).then(null,function(e){i.alert(e)})},r.deleteUpload=function(t){i.alert({title:"Really ?",message:"This will remove "+t.files.length+" file(s) from the server",confirm:!0}).result.then(function(){a.removeUpload(t).then(function(){r.uploads=_.reject(r.uploads,function(e){return e.id===t.id})}).then(null,function(e){i.alert(e)})},function(){})},r.createUser=function(){i.openDialog({backdrop:!0,backdropClick:!0,templateUrl:"partials/user.html",controller:"UserController",resolve:{args:function(){return{}}}}).result.then(function(e){e.user?a.createUser(e.user).then(function(e){r.displayUsers()}).then(null,function(e){i.alert(e)}):e.error&&i.alert(e.error)},function(){})},r.editUser=function(e){i.openDialog({backdrop:!0,backdropClick:!0,templateUrl:"partials/user.html",controller:"UserController",resolve:{args:function(){return{user:e}}}}).result.then(function(e){e.user?a.updateUser(e.user).then(function(e){r.displayUsers()}).then(null,function(e){i.alert(e)}):e.error&&i.alert(e.error)},function(){})},r.deleteUser=function(t){i.alert({title:"Really ?",message:"This will remove "+t.provider+" user "+t.login+" from the server",confirm:!0}).result.then(function(){a.deleteUser(t).then(function(){r.users=_.reject(r.users,function(e){return e.id===t.id})}).then(null,function(e){i.alert(e)})},function(){})},r.impersonate=function(e){if(!e)return r.setFakeUser(void 0),void t.refreshUser();r.original_user.id!==e.id&&(r.setFakeUser(e),a.getUser().then(function(){t.refreshUser()}).then(null,function(e){i.alert(e),r.setFakeUser(void 0)}))},r.setFakeUser=function(e){a.fake_user=e,r.fake_user=e},r.getUserMaxFileSize=function(e){return 0<e.maxFileSize?r.humanReadableSize(e.maxFileSize):0===e.maxFileSize&&0<r.config.maxFileSize?"default":"unlimited"},r.getUserMaxUserSize=function(e){return 0<e.maxUserSize?r.humanReadableSize(e.maxUserSize):0===e.maxUserSize&&0<r.config.maxUserSize?"default":"unlimited"},r.getUserMaxTTL=function(e){return 0<e.maxTTL?getHumanReadableTTLString(e.maxTTL):0===e.maxTTL&&0<r.config.maxTTL?"default":"unlimited"},r.getUploadUrl=function(e){return a.base+"/#/?id="+e.id},r.getFileUrl=function(e,t){return a.base+"/file/"+e.id+"/"+t.id+"/"+t.fileName},r.getHumanReadableTTLString=getHumanReadableTTLString,r.humanReadableSize=getHumanReadableSize,r.displayStats()}]),plik.controller("ClientListCtrl",["$scope","$api","$dialog",function(t,n,r){t.clients=[],n.getVersion().then(function(e){t.clients=e.clients}).then(null,function(e){r.alert(e)}),t.getClientPath=function(e){return n.base+e.path}}]),plik.controller("HomeCtrl",["$scope","$api","$config","$dialog","$location",function(n,r,e,a,t){n.display="uploads",n.displayUploads=function(e){n.uploads=[],n.token=e,n.display="uploads",n.refreshUser()},n.displayTokens=function(){n.display="tokens",n.refreshUser()},e.config.then(function(e){e.authentication||t.path("/")}).then(null,function(e){a.alert(e)});var i=function(e){e.then(function(e){n.user=e,n.getUploads(),n.getTokens(),n.getUserStats(),n.fake_user=r.fake_user}).then(null,function(e){401===e.status||403===e.status?t.path("/login"):a.alert(e)})};n.refreshUser=function(){i(e.refreshUser())},n.limit=50,n.getUploads=function(e){e||(n.uploads=[],n.upload_cursor=void 0),r.getUserUploads(n.token,n.limit,n.upload_cursor).then(function(e){n.uploads=n.uploads.concat(e.results),n.upload_cursor=e.after}).then(null,function(e){a.alert(e)})},n.getTokens=function(e){e||(n.tokens=[],n.tokens_cursor=void 0),r.getUserTokens(n.limit,n.tokens_cursor).then(function(e){n.tokens=n.tokens.concat(e.results),n.tokens_cursor=e.after}).then(null,function(e){a.alert(e)})},n.getUserStats=function(){r.getUserStats().then(function(e){n.user.stats=e}).then(null,function(e){a.alert(e)})},n.deleteUpload=function(t){a.alert({title:"Really ?",message:"This will remove "+t.files.length+" file(s) from the server",confirm:!0}).result.then(function(){r.removeUpload(t).then(function(){n.uploads=_.reject(n.uploads,function(e){return e.id===t.id})}).then(null,function(e){a.alert(e)})},function(){})},n.deleteUploads=function(){a.alert({title:"Really ?",message:"This will remove all uploads from the server",confirm:!0}).result.then(function(){r.deleteUploads(n.token).then(function(e){n.uploads=[],n.getUploads(),a.alert(e)}).then(null,function(e){a.alert(e)})},function(){})},n.createToken=function(e){r.createToken(e).then(function(){n.refreshUser()}).then(null,function(e){a.alert(e)})},n.revokeToken=function(e){a.alert({title:"Really ?",message:"Revoking a token will not delete associated uploads.",confirm:!0}).result.then(function(){r.revokeToken(e.token).then(function(){n.refreshUser()}).then(null,function(e){a.alert(e)})},function(){})},n.logout=function(){r.logout().then(function(){e.refreshUser(),t.path("/")}).then(null,function(e){a.alert(e)})},n.deleteAccount=function(){a.alert({title:"Really ?",message:"Deleting your account will not delete your uploads.",confirm:!0}).result.then(function(){r.deleteAccount().then(function(){e.refreshUser(),t.path("/")}).then(null,function(e){a.alert(e)})},function(){})},n.editAccount=function(){a.openDialog({backdrop:!0,backdropClick:!0,templateUrl:"partials/user.html",controller:"UserController",resolve:{args:function(){return{user:n.user}}}}).result.then(function(e){e.user?r.updateUser(e.user).then(function(e){}).then(null,function(e){a.alert(e)}):e.error&&a.alert(e.error)},function(){})},n.getUploadUrl=function(e){return r.base+"/#/?id="+e.id},n.getFileUrl=function(e,t){return r.base+"/file/"+e.id+"/"+t.id+"/"+t.fileName},n.humanReadableSize=getHumanReadableSize,n.mainpage=function(){t.search({}),t.hash(""),t.path("/")},i(e.getUser())}]),plik.controller("LoginCtrl",["$scope","$api","$config","$location","$dialog",function(t,e,n,r,a){setTimeout(function(){$("#login").focus()},100),n.getConfig().then(function(e){(t.config=e).authentication||r.path("/")}).then(null,function(e){401!==e.status&&403!==e.status&&a.alert(e)}),n.getUser().then(function(){r.path("/home")}).then(null,function(e){401!==e.status&&403!==e.status&&a.alert(e)}),t.google=function(){e.login("google").then(function(e){window.location.replace(e)}).then(null,function(e){a.alert(e)})},t.ovh=function(){e.login("ovh").then(function(e){window.location.replace(e)}).then(null,function(e){a.alert(e)})},t.login=function(){e.login("local",t.username,t.password).then(function(){n.refreshUser(),r.path("/home")}).then(null,function(e){a.alert(e)})}}]),plik.controller("MainCtrl",["$scope","$api","$config","$route","$location","$dialog","$timeout","$paste","$q",function(o,l,e,t,r,a,s,n,i){var u=function(e){};o.mode="upload",o.sortField="fileName",o.sortOrder=!1,o.user=null,o.config=null,o.upload={},o.files=[],o.password=!1,o.enableComments=!1;var c=["/","#","?","%",'"'];function f(e){o.ready.then(e,u)}o.isFeatureEnabled=function(e){if(!o.config)return!1;var t=o.config["feature_"+e];return t&&"disabled"!==t},o.isFeatureDefault=function(e){if(!o.config)return!1;var t=o.config["feature_"+e];return"default"===t||"forced"===t},o.isFeatureForced=function(e){return!!o.config&&"forced"===o.config["feature_"+e]},o.configReady=i.defer(),e.getConfig().then(function(e){o.config=e,o.upload.oneShot=o.isFeatureDefault("one_shot"),o.upload.removable=o.isFeatureDefault("removable"),o.upload.stream=o.isFeatureDefault("stream"),o.password=o.isFeatureDefault("password"),o.enableComments=o.isFeatureDefault("comments"),o.configReady.resolve(!0)}).then(null,function(e){a.alert(e).result.then(o.mainpage)}),o.userReady=i.defer(),e.getUser().then(function(e){o.user=e}).then(null,function(e){401!==e.status&&403!==e.status&&a.alert(e).result.then(o.mainpage)}).finally(function(){o.userReady.resolve(!0)}),o.loaded=i.defer(),o.load=function(){var e=r.search().err;if(_.isUndefined(e)){var t=r.search().id;t?(o.mode="download",o.upload.id=t,o.upload.uploadToken=r.search().uploadToken,l.getUpload(o.upload.id,o.upload.uploadToken).then(function(e){_.extend(o.upload,e),o.files=o.upload.files,o.loaded.resolve(!0)}).then(null,function(e){a.alert(e).result.then(o.mainpage).then(o.mainpage)})):o.loaded.resolve(!0)}else{var n=r.search().errcode;a.alert({status:n,message:e}).result.then(o.mainpage)}},o.load(),o.ready=i.all([o.configReady.promise,o.userReady.promise,o.loaded.promise]),f(function(){!o.isFeatureForced("authentication")||"upload"!==o.mode||o.user||o.uploadToken||r.path("/login"),o.setDefaultTTL()}),o.fileNameValidator=function(t){return!_.isUndefined(t)&&(!(0===t.length||1024<t.length)&&_.every(c,function(e){return-1===t.indexOf(e)}))};var d=-1,p=function(){return(++d).toString()};o.isAppleShit=function(){return navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)},o.checkMaxFileSize=function(e){var t=o.config.maxFileSize;return o.user&&0<o.user.maxFileSize&&(t=o.user.maxFileSize),!(t&&t<e)||(a.alert({status:0,message:"File is too big : "+getHumanReadableSize(e),value:"Maximum allowed size is : "+getHumanReadableSize(o.config.maxFileSize)}),!1)},o.onFileSelect=function(e){_.each(e,function(e){if(o.checkMaxFileSize(e.size)){var t=_.pluck(o.files,"fileName");if(o.isAppleShit()&&_.contains(t,e.name)){e.reference=p();var n=e.name.lastIndexOf("."),r=n?e.name.substr(0,n):e.name,a=e.name.substr(n+1);r=r+"."+e.reference+"."+a,Object.defineProperty(e,"name",{value:r,writable:!0})}_.contains(t,e.name)||(e.reference||(e.reference=p()),e.fileName=e.name,e.fileSize=e.size,e.fileType=e.type,e.status="toUpload",o.files.push(e))}})},o.waterDrop=function(e){var t=$("body"),n=$(document.createElement("div")).css({left:e.clientX-50,top:e.clientY-50}).appendTo(t),r=$(document.createElement("div")).css({left:e.clientX-50,top:e.clientY-50}).appendTo(t);n.addClass("pulse1"),r.addClass("pulse2"),setTimeout(function(){n.remove(),r.remove()},1100)},o.onFileDrop=function(e,t){o.onFileSelect(e),o.waterDrop(t)},o.removeFile=function(t){o.files=_.reject(o.files,function(e){return e.reference===t.reference})},o.newUpload=function(t){if(t||o.files.length)if(o.upload.id)o.uploadFiles();else{if(!o.checkTTL())return;if(o.upload.ttl=getTTL(o.ttlValue,o.ttlUnit),o.password&&(!o.upload.login||!o.upload.password))return void o.getPassword();if(o.upload.files=[],_.find(o.files,function(e){return 1024<e.fileName.length?(a.alert({status:0,message:"File name max length is 1024 characters"}),!0):o.fileNameValidator(e.fileName)?void o.upload.files.push({fileName:e.fileName,fileType:e.fileType,fileSize:e.fileSize,reference:e.reference}):(a.alert({status:0,message:"Invalid file name "+e.fileName+"\n",value:"Forbidden characters are : "+c.join(" ")}),!0)}))return;l.createUpload(o.upload).then(function(e){o.upload=e,_.each(o.upload.files,function(t){_.every(o.files,function(e){return e.reference!==t.reference||(_.extend(e,t),!(e.status="toUpload"))})}),r.search("id",o.upload.id),t&&o.setAdminUrl(),o.uploadFiles()}).then(null,function(e){a.alert(e)})}},o.uploadFiles=function(){o.upload.id&&(o.mode="download",_.each(o.files,function(t){if("toUpload"===t.status){t.status="uploading",l.uploadFile(o.upload,t,function(e){t.progress=parseInt(100*e.loaded/e.total)},o.basicAuth).then(function(e){_.extend(t,e),o.somethingOk()||o.mainpage()}).then(null,function(e){t.status="toUpload",a.alert(e)})}}))},o.removeUpload=function(){(o.upload.removable||o.upload.admin)&&a.alert({title:"Really ?",message:"This will remove "+o.files.length+" file(s) from the server",confirm:!0}).result.then(function(){l.removeUpload(o.upload).then(function(){o.mainpage()}).then(null,function(e){a.alert(e)})},u)},o.deleteFile=function(t){(o.upload.removable||o.upload.admin)&&a.alert({title:"Really ?",message:"This will remove 1 file from the server",confirm:!0}).result.then(function(){l.removeFile(o.upload,t).then(function(){o.files=_.reject(o.files,function(e){return e.id===t.id}),o.files.length||o.mainpage()}).then(null,function(e){a.alert(e)})},u)},o.isDownloadable=function(e){if(o.upload.stream){if("uploading"===e.status)return!0}else if("uploaded"===e.status)return!0;return!1},o.isOk=function(e){return"toUpload"===e.status||("uploading"===e.status||("uploaded"===e.status||!(!o.upload.stream||"missing"!==e.status)))},o.somethingToUpload=function(){return _.find(o.files,function(e){if("toUpload"===e.status)return!0})},o.somethingToDownload=function(){return _.find(o.files,function(e){return o.isDownloadable(e)})},o.somethingOk=function(){return _.find(o.files,function(e){return o.isOk(e)})},o.okToAddFiles=function(){return"upload"===o.mode||!o.upload.stream&&o.upload.admin},o.humanReadableSize=getHumanReadableSize,o.getMode=function(){return o.upload.stream?"stream":"file"};var g=function(e,t,n,r,a){var i=(o.config.downloadDomain?o.config.downloadDomain:l.base)+"/"+e+"/"+t;return n&&(i+="/"+n),r&&(i+="/"+r),a&&(i+="?dl=1"),encodeURI(i)};o.getFileUrl=function(e,t){if(e&&e.id&&e.fileName)return g(o.getMode(),o.upload.id,e.id,e.fileName,t)},o.getZipArchiveUrl=function(e){if(o.upload.id)return g("archive",o.upload.id,null,"archive.zip",e)},o.getQrCodeUrl=function(e,t){if(e)return l.base+"/qrcode?url="+encodeURIComponent(e)+"&size="+t},o.getQrCodeUploadUrl=function(e){return o.getQrCodeUrl(window.location.href,e)},o.getQrCodeFileUrl=function(e,t){return o.getQrCodeUrl(o.getFileUrl(o.qrcode,!1),t)},o.displayQRCodeUpload=function(){var e=window.location.href,t=o.getQrCodeUrl(e,400);o.displayQRCode(e,e,t)},o.displayQRCodeFile=function(e){var t=o.getFileUrl(e,!1),n=o.getQrCodeUrl(t,400);o.displayQRCode(e.fileName,t,n)},o.displayQRCode=function(e,t,n){a.openDialog({backdrop:!0,backdropClick:!0,templateUrl:"partials/qrcode.html",controller:"QRCodeController",resolve:{args:function(){return{title:e,url:t,qrcode:n}}}})},o.getPassword=function(){a.openDialog({backdrop:!0,backdropClick:!0,templateUrl:"partials/password.html",controller:"PasswordController"}).result.then(function(e){o.upload.login=e.login,o.upload.password=e.password,o.basicAuth=btoa(e.login+":"+e.password),o.newUpload()},u)},o.ttlUnits=["days","hours","minutes"],o.ttlUnit="days",o.ttlValue=30,o.checkTTL=function(){var e=!0;"unlimited"===o.ttlUnit&&(o.ttlValue=-1);var t=getTTL(o.ttlValue,o.ttlUnit);if("unlimited"!==o.ttlUnit&&t<0&&(e=!1),n=o.config.maxTTL,o.user&&0!==o.user.maxTTL&&(n=o.user.maxTTL),0<n&&n<t&&(e=!1),!e){var n=getHumanReadableTTL(n);a.alert({status:0,message:"Invalid expiration delay : "+o.ttlValue+" "+o.ttlUnit+". Maximum is : "+n[0]+" "+n[1]}),o.setDefaultTTL()}return e},o.setDefaultTTL=function(){maxTTL=o.config.maxTTL,o.user&&0!==o.user.maxTTL&&(maxTTL=o.user.maxTTL),maxTTL<0&&(o.ttlUnits=["days","hours","minutes","unlimited"]),o.user&&0<o.user.maxTTL&&o.config.defaultTTL>o.user.maxTTL&&(o.config.defaultTTL=o.user.maxTTL);var e=getHumanReadableTTL(o.config.defaultTTL);o.ttlValue=e[0],o.ttlUnit=e[1]},o.getExpirationDate=function(){if(-1===o.upload.ttl)return"never expire";var e=new Date(o.upload.expireAt);return"expire on "+e.toLocaleDateString()+" at "+e.toLocaleTimeString()},o.displayAdminUrlLink=function(){return o.upload.uploadToken&&!r.search().uploadToken},o.setAdminUrl=function(){r.search("uploadToken",o.upload.uploadToken)},o.focus=function(e){angular.element("#"+e)[0].focus()},o.mainpage=function(){r.search({}),r.hash(""),t.reload()},o.pasteCallback=function(e){if(o.okToAddFiles()&&!(0<document.getElementsByClassName("modal-open").length)){if(!o.isFeatureForced("text")){var t=_.clone(e.files);if(t.length)return void s(function(){o.onFileSelect(t)})}if(o.isFeatureEnabled("text")){var n=e.getData("text");n&&o.openTextDialog(n)}}},o.openTextDialog=function(e){a.openDialog({backdrop:!0,backdropClick:!0,templateUrl:"partials/paste.html",controller:"PasteController",size:"lg",resolve:{args:function(){return{text:e}}}}).result.then(function(e){if(e.text){for(var t="paste.txt",n=_.pluck(o.files,"fileName"),r=1;_.contains(n,t);)t="paste."+r+".txt",r++;var a=new Blob([e.text],{type:"text/plain;charset=utf-8"}),i=new File([a],t,{type:"text/plain;charset=utf-8"});s(function(){o.onFileSelect([i])})}},u)},o.registerPasteHandler=function(){n.register(o.pasteCallback),o.$on("$routeChangeStart",n.unregister)},f(function(){o.registerPasteHandler(),o.isFeatureDefault("text")&&o.openTextDialog()})}]),plik.controller("MenuCtrl",["$rootScope","$scope","$config",function(e,n,t){t.getConfig().then(function(e){n.config=e},function(){}),e.$on("config_refreshed",function(e,t){t.then(function(e){n.config=e}).then(null,function(){n.config=null})}),n.isFeatureEnabled=function(e){if(!n.config)return!1;var t=n.config["feature_"+e];return t&&"disabled"!==t},t.getUser().then(function(e){n.user=e},function(){}),e.$on("user_refreshed",function(e,t){t.then(function(e){n.user=e}).then(null,function(){n.user=null})})}]),plik.controller("UserController",["$scope","args","$config","$q",function(a,e,t,n){a.title="User :",a.providers=["local","google","ovh"],a.edit=!1,a.user={},a.warning=null,a.configReady=n.defer(),t.getConfig().then(function(e){a.config=e,a.configReady.resolve(!0)}).then(null,function(e){a.$close({error:e})}),a.userReady=n.defer(),t.getUser().then(function(e){a.auth_user=e,a.userReady.resolve(!0)}).then(null,function(e){a.$close({error:e})}),a.maxFileSize=-1,a.ttlUnits=ttlUnits,a.ttlUnits[3]="unlimited",a.ttlUnit="days",a.ttlValue=30,a.setMaxTTL=function(e){var t=getHumanReadableTTL(e);a.ttlValue=t[0],a.ttlUnit=a.ttlUnits[t[2]]},a.setMaxFileSize=function(e){a.maxFileSize=0<e?getHumanReadableSize(e):e},a.setMaxUserSize=function(e){a.maxUserSize=0<e?getHumanReadableSize(e):e},a.ready=n.all([a.configReady,a.userReady]),a.ready.then(function(){if(e.user){if(!a.auth_user.admin&&e.user.id!==a.auth_user.id)return void a.closeWithError("forbidden");a.edit=!0,a.user=e.user,a.setMaxTTL(a.user.maxTTL),a.setMaxFileSize(a.user.maxFileSize),a.setMaxUserSize(a.user.maxUserSize)}else a.user.provider="local",a.setMaxTTL(0),a.setMaxFileSize(0),a.setMaxUserSize(0),a.generatePassword()}).then(function(){}),a.generatePassword=function(){for(pass="",i=0;i<2;i++)pass+=window.crypto.getRandomValues(new BigUint64Array(1))[0].toString(36);a.user.password=pass},a.checkTTL=function(e){return!("unlimited"!==a.ttlUnit&&e<0)||(a.warning="Invalid max TTL : "+getHumanReadableTTLString(e),!1)},a.check=function(e){if(a.warning=null,!a.edit&&(!e.login||e.login.length<4))return!(a.warning="invalid login (min 4 chars)");if((!a.edit||e.password)&&(!e.password||e.password.length<8))return!(a.warning="invalid password (min 8 chars)");var t=getTTL(a.ttlValue,a.ttlUnit);if(!a.checkTTL(t))return!1;a.user.maxTTL=t;var n=parseHumanReadableSize(a.maxFileSize,{base:10});if(_.isNumber(n))a.user.maxFileSize=n;else{if(0!==(n=Number(a.maxFileSize))&&-1!==n)return!(a.warning="invalid max file size");a.user.maxFileSize=n}var r=parseHumanReadableSize(a.maxUserSize,{base:10});if(_.isNumber(r))a.user.maxUserSize=r;else{if(0!==(r=Number(a.maxUserSize))&&-1!==r)return!(a.warning="invalid max user size");a.user.maxUserSize=r}return!0},a.closeWithError=function(e){a.$close({error:e})},a.close=function(e){a.check(e)&&a.$close({user:e})}}]);
//# sourceMappingURL=app.js.map